name: Update token link

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *"

permissions:
  contents: write

jobs:
  update-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch token and update link
        shell: bash
        run: |
          set -euo pipefail
          issue_json=$(curl -s https://api.github.com/repos/wzdnzd/aggregator/issues/91)
          token=$(ISSUE_JSON="$issue_json" python - <<'PY'
import json, os, re, sys
data=json.loads(os.environ['ISSUE_JSON'])
body=data.get('body','')
match=re.search(r"`([a-zA-Z0-9]+)`", body)
if not match:
    sys.exit('token not found')
print(match.group(1))
PY
          )
          url="https://qybndbviblvt.us-west-1.clawcloudrun.com/api/v1/subscribe?token=${token}&target=Clash&list=true"
          printf '%s\n' "$url" > latest_url.txt

      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add latest_url.txt
          git commit -m "Update latest token url"
          git push
